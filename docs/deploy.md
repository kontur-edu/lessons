# Деплой
**Внимание**. Описанные ниже вещи относятся к деплою основного инстанса юлёрна (ulearn.me). Большинство используемых ресурсов доступно только внутри сетей Контура и только его сотрудникам.

Юлёрн компилируется с помощью CI-системы TeamCity, разверёрнутой в Контуре: https://tc.skbkontur.ru. Скомпилированные проекты пакуются в nuget-пакеты (через nuspec-файлы для проектов на .NET Framework и через `dotnet pack` для проектов на .NET Core) и отправлятся в репозиторий [Октопуса](https://octopus.com) https://octo.skbkontur.ru. 

Процесс деплоя описан в Октопусе (проект Ulearn, права можно получить у Паши Егорова) и состоит из следующих шагов:
- создание пользователя ulearn 
- создание на файловой системе папок C:\ulearn\{courses,logs,certificates,...} и выдача прав на них пользователю
- установка .NET Core нужной версии (с помощью PowerShell скрипта, проверяющего текущую версию и скачивающую новую, если нужно. Будьте аккуратны: иногда установка следующей версии требует перезагрузить сервер. Этот шаг этого не сделает).
- установка IIS и необходимых модулей к нему (наример, URL Rewrite) на сервера с ролью `ulearn-web-server` 
- деплой нужных пакетов из репозитория Октопуса на сервера с определёнными ролями
- создание тасков в виндовом шедулере для запуска нужных процессов-демонов (делается в Post-Install-скриптах соотвествующих шагов). Проект Ulearn.Web деплоится через IIS созданием там пула и сайта в нём.
- установка дополнительного софта (браузер, Far Manager), если необходимо (обычно только на тестовую площадку).

В Октопусе для проекта Ulearn определены 4 окружения: Production, Staging, Testing и LoadTesting. Первое деплоит юлёрн на все 4 виндовых сервера, которые сейчас используются (ulearn-win-01, ulearn-win-02, ulearn-win-03, ulearn-win-04). Первый используется для хостинга веб-приложений (Ulearn.Web и Web.Api), демона уведомлений (Notifications), xqueue-демона (XQueueWatcher) и других, которым нужен доступ к курсам, хранящимся на файловой системе. Кроме того, на нём запускается микросервис антиплагиата.

Остальных три сервера используются для хостинга RunCsJob — демона, запускающего решения студентов.

ОКружение Staging используется для выкатки полного набора сервисов на сервер ulearn-win-02. Веб-интерфейс этого окружения доступе по адресу https://dev.ulearn.me и используется разработчиками как главная демонстрационная и тестовая площадка для новых возможностей.

Окружения Testing и LoadTesting выкладывают сервисы на сервера, не находящиеся в домене SYS-MSK и доступные по подписке (см. https://dev-cloud.skbkontur.ru). Окружение Testing выкладывает юлёрн на сервер ulearn-test-01 (который использует базу данных, развёрнутую на ulearn-test-db), а LoadTesting — на сервер ulearn-load-01 (использовался для нагрузочного тестирования и обстрела из Яндекс.Танка). 